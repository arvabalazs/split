<!doctype html>
<html></html>
<head>
	<title>Split</title>
	<style>
		body {
			overflow: hidden;
		}

		.hide {
			display: none !important;
		}

		iframe {
			pointer-events: none;
		}

		.player:not(.focused) {
			border: 1px transparent solid;
		}

		.active:not(.focused) {
			border: 1px yellow solid;
		}

		.focused {
			position: absolute;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
		}

		.focused>iframe {
			width: 100%;
			height: 100%;
		}
	</style>
</head>
<body style="margin: 0; background-color: black;">
	<nav>
		<div style="color: white; display: flex; flex-flow: row; gap: 16px">
			<div>
				<p>1. Add up to 4 YouTube or Twitch URLs</p>
				<p>2. Press START which loads muted videos</p>
				<p>3. Press 1, 2, 3 or 4 to switch stream</p>
			</div>
			<div>
				<p>4. Press E to focus/unfocus the active stream</p>
				<p>5. Press M to mute/unmute the active stream</p>
				<p>6. Press F to go fullscreen and hide menu</p>
			</div>
		</div>

		<input class="stream_id" id=player1_stream>
		<input class="stream_id" id=player2_stream>
		<input class="stream_id" id=player3_stream>
		<input class="stream_id" id=player4_stream>
		<button onclick="start()">START</button>
		<a id=share_url>Share URL</a>
	</nav>
	<main id=main style="display: grid; grid-template-rows: 1fr 1fr; grid-template-columns: 1fr 1fr">
		<div class="player" id=player1></div>
		<div class="player" id=player2></div>
		<div class="player" id=player3></div>
		<div class="player" id=player4></div>
	</main>
	<script src="https://www.youtube.com/iframe_api"></script>
	<script src="https://player.twitch.tv/js/embed/v1.js"></script>
	<script>
		function mute(player) {
			if (player.kind == "yt")
				player.player.mute();
			else if (player.kind == "twitch") {
				player.player.setVolume(0.0);
				player.player.setMuted(true);
			}
		}

		function unmute(player) {
			if (player.kind == "yt") {
				player.player.unMute();
			} else if (player.kind == "twitch") {
				player.player.setVolume(1.0);
				player.player.setMuted(false);
			}
		}

		function destroy(player) {
			if (player.kind == "yt") {
				player.player.destroy();
			} else if (player.kind == "twitch") {
				// TODO: what should we do with twitch?e
			}
		}

		const url = new URL(window.location);
		let ind = 0;
		for (const k of url.searchParams.keys()) {
			document.querySelectorAll(".stream_id")[ind].value = decodeURIComponent(url.searchParams.get(k));
			++ind;
		}

		let players = [];
		function start() {
			let share_urls_params = [];
			for (const player of players) {
				destroy(player);
			}
			players = [];
			document.querySelectorAll(".stream_id").forEach(e => {
				if (e.value.length > 0) {
					const url = new URL(e.value);
					if (url.hostname === "youtube.com" || url.hostname === "www.youtube.com") {
						const videoId = url.searchParams.get("v");
						if (videoId) {
							players.push({
								kind: 'yt',
								player: new YT.Player(`player${players.length + 1}`, {
									width: (screen.width - 2) / 2,
									height: (screen.height - 2) / 2,
									videoId,
									playerVars: {
										'playsinline': 1,
										"autoplay": 1,
										"mute": 1,
										"controls": 0,
										"modestbranding": 1,
										"disablekb": 1
									}
								})
							});
						}
					} else if (url.hostname === "twitch.tv" || url.hostname === "www.twitch.tv") {
						const options = {
							width: (screen.width - 2) / 2,
							height: (screen.height - 2) / 2,
							channel: url.pathname.substring(1),
						};
						players.push({
							kind: 'twitch',
							player: new Twitch.Player(`player${players.length + 1}`, options)
						});
					}

					share_urls_params.push(`p${share_urls_params.length}=${encodeURIComponent(e.value)}`);
				}
			});

			const share_url = window.location.protocol + "//" + window.location.hostname + location.pathname + "?" + share_urls_params.join("&");
			document.getElementById("share_url").href = share_url;
		}

		function onYouTubeIframeAPIReady() { }
		let focused = false;
		let active = 0;
		let muted = true;
		document.querySelectorAll(".player")[active].classList.toggle("active");

		function mute_all() {
			for (const player of players) {
				mute(player);
			}

			document.querySelectorAll(".player").forEach(e => e.classList.remove("active"))
		}

		if (document.body.requestFullscreen) {
			document.body.addEventListener('keydown', function (e) {
				if (e.key == "f" && document.fullscreenEnabled) {
					document.getElementById("main").requestFullscreen();
				} else if (e.key == "1" || e.key == "2" || e.key == "3" || e.key == "4") {
					active = parseInt(e.key, 10) - 1;
					mute_all();
					unmute(players[active]);
					document.querySelectorAll(".player")[active].classList.toggle("active");
					muted = false;
				} else if (e.key == "e") {
					document.querySelectorAll(".player").forEach(e => e.classList.toggle("hide"))
					const player = document.getElementById(`player${active + 1}`);
					focused = !focused;
					player.classList.toggle("focused");
					player.classList.toggle("hide");
				} else if (e.key == "m") {
					if (muted && active >= 0) {
						unmute(players[active]);
						document.querySelectorAll(".player")[active].classList.toggle("active");
						muted = false;
					} else {
						muted = true;
						mute_all();
					}
				}
			});
		}
	</script>
</body>